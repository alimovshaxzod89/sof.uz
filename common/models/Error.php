<?php

namespace common\models;

use yii\data\ActiveDataProvider;
use yii\helpers\ArrayHelper;

/**
 * Class Error
 * @package common\models
 * @property mixed  url
 * @property  mixed text
 * @property mixed  status
 * @property mixed  message
 */
class Error extends MongoModel
{
    protected $_searchableAttributes = ['text', 'message'];
    const STATUS_NEW = 'new';
    const STATUS_PROCESSING = 'processing';
    const STATUS_FIXED = 'fixed';

    public function attributes()
    {
        return ArrayHelper::merge(parent::attributes(), [
            'url',
            'text',
            'status',
            'message',
        ]);
    }

    public function rules()
    {
        return [
            ['status', 'safe', 'on' => 'update'],
            [['status', 'search'], 'safe', 'on' => 'search'],
        ];
    }

    public static function collectionName()
    {
        return 'error';
    }

    public static function getStatusOptions($empty = false)
    {
        $data = [
            self::STATUS_NEW   => __('New'),
            self::STATUS_FIXED => __('Fixed'),
        ];

        return $empty ? array_merge(['' => ''], $data) : $data;
    }

    public function beforeSave($insert)
    {
        foreach (['url', 'text', 'message'] as $att) {
            $this->$att = strip_tags($this->$att);
        }

        return parent::beforeSave($insert); // TODO: Change the autogenerated stub
    }

    public function search($params)
    {
        $this->load($params);
        $query = self::find();

        $dataProvider = new ActiveDataProvider([
                                                   'query'      => $query,
                                                   'sort'       => [
                                                       'defaultOrder' => ['created_at' => 'DESC'],
                                                   ],
                                                   'pagination' => [
                                                       'pageSize' => 20,
                                                   ],
                                               ]);


        if ($this->search) {
            foreach ($this->_searchableAttributes as $attribute) {
                $query->orFilterWhere([$attribute => ['$regex' => $this->search, '$options' => 'si']]);

            }
        }

        if ($this->status) {
            $query->andFilterWhere(['status' => $this->status]);
        }
        return $dataProvider;

    }

}